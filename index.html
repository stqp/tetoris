<html>
<head></head>
<body>
</body>
<script>

  function pxToInt(v){
    return parseInt(v, 10);
  }

  var block_px = 20;
  var map_w = 10; // block 10 ko.
  var map_h = 20;
  var map ;
  var cur_block ;

  var cur_blocks;

  function getDownElem(elem){
    let par = elem.parentNode;
    let c=0;
    let pre = elem.previousSibling
    while(pre){
      c++;
      pre = pre.previousSibling;
    }
    let down = par.nextSibling;
    if(!down) return null;

    down = down.children[0];
    while(c>0){
      down = down.nextSibling;
      c--;
    }
    return down;
  }


  function init(){
    map = document.createElement("table");
    map.setAttribute("id","map");

    for(let i = 0; i< map_h;i++){
      var tr = document.createElement("tr");
      for(let j=0;j<map_w;j++){
        var dot = document.createElement("td");
        dot.style.width = block_px;
        dot.style.height = block_px;
        tr.appendChild(dot);
      }
      map.appendChild(tr);
    }
    document.body.appendChild(map);
  }

  function makeBlock(){
    cur_block =  map.children[0].children[0];
    onBlock(cur_block,"red");
  }

  function makeBlocks(){
    let type = Math.floor( Math.random() * 7 ) ;
    let offset = 1; // offset from left-most edge of the map to left-most of newly created block.
    let color = "red";
    cur_blocks = [];
    switch(type){
      case 0: // I-block
        for(let i=0;i<4;i++) cur_blocks.push(map.children[i].children[offset]);
        color = "lightskyblue";break;
      case 1: // J-block
        cur_blocks.push(map.children[0].children[offset]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "blue";break;
      case 2: // L-block
        cur_blocks.push(map.children[0].children[offset+2]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "orange";break;
      case 3: // O-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "yellow";break;
      case 4: // S-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+1+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "green";break;
      case 5: // T-block
        cur_blocks.push(map.children[0].children[offset+1]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "purple";break;
      case 6: // Z-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+1+i]);
        color ="red";break;
    }
    onBlocks(cur_blocks,color);
  }

  function onBlocks(elems,color){
    for(let elem of elems){
      elem.style["background-color"] = color;
      elem.isBlock = true;
    }
  }
  function offBlocks(elems){
    for(let elem of elems){
      elem.style["background-color"] = "white";
      elem.isBlock = false;
    }
  }

  function onBlock(elem,color){
    elem.style["background-color"] = color;
    elem.isBlock = true;
  }
  function offBlock(elem){
    elem.style["background-color"] = "white";
    elem.isBlock = false;
  }

  init();

  function moveDown(){
    let next_cur_blocks = [];
    for(let i=cur_blocks.length-1;i>=0;i--){
      let next_cur_block = getDownElem(cur_blocks[i]);
      if(!next_cur_block || (!cur_blocks.includes(next_cur_block) && next_cur_block.isBlock)){
        checkLine();
        cur_blocks = null;
        return;
      }
      next_cur_blocks.push(next_cur_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(next_cur_blocks, color);
    cur_blocks = next_cur_blocks;
  }

  function moveRight(){
    let right_blocks = [];
    for(let cur_block of cur_blocks){
      let right_block = cur_block.nextSibling;
      if(!right_block || (!cur_blocks.includes(right_block) &&right_block.isBlock)){
        return;
      }
      right_blocks.push(right_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(right_blocks,color);
    cur_blocks = right_blocks;
  }


  function moveLeft(){
    let left_blocks = [];
    for(let cur_block of cur_blocks){
      let left_block = cur_block.previousSibling;
      if(!left_block || (!cur_blocks.includes(left_block) && left_block.isBlock)){
        return;
      }
      left_blocks.push(left_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(left_blocks,color);
    cur_blocks = left_blocks;
  }


  function checkLine(){

    let line = map.children[0];
    while(line){
      let f = true;
      let elem = line.children[0];
      while(elem){
        if(!elem.isBlock){
          f = false;
          break;
        }
        elem = elem.nextSibling;
      }
      if(f){
        let block = line.children[0];
        while(block){
          offBlock(block)
          block = block.nextSibling;
        }
        let line_tmp = line.previousSibling;
        while(line_tmp){
          let elem = line_tmp.children[0];
          while(elem){
            let down_elem= getDownElem(elem);
            let color = elem.style.backgroundColor;
            if(elem.isBlock) onBlock(down_elem,color);
            offBlock(elem);
            elem = elem.nextSibling;
          }
          line_tmp = line_tmp.previousSibling;
        }
        cur_block = null;
      }
      line = line.nextSibling;
    }
  }

  function rotate() {
    
  }

  function manager(){
    if(!cur_blocks){
      makeBlocks();
    }else{
      moveDown()
    }
  }


  document.onkeydown = function(event){
    event.preventDefault()
    if(!cur_blocks) return;
    if (event.keyCode === 37){
      moveLeft();
    }else if (event.keyCode === 39){
      moveRight();
    }else if (event.keyCode === 40){
      moveDown();
    }
  }

  setInterval(function(){
    manager();
  },300);
  

</script>

<style type="text/css">
  html,body,document{
    width:1000px;
    height:1000px;

  }
  table{
    border-collapse: collapse;
    position:absolute;
    left:10px;
    top:10px;
    width:200px;
    height:300px;
  }
  table td{
    border: 1px solid black;
  }

  .block{
    width:20px;
    height:20px;
    border:0px solid red;
    background-color: red;
  }
</style>
</html>