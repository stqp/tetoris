<html>
<head></head>
<body>

  <div id="area">
    <div>現在のスコア:<div id="score">0</div></div>
    <table id="map"></table>

  </div>

</body>
<script>

  function pxToInt(v){
    return parseInt(v, 10);
  }

  function sleep(s){
    const d1 = new Date();
    while (true) {
      const d2 = new Date();
      if (d2 - d1 > s) {
        break;
      }
    }
  }

  var block_px = 20;
  var map_w = 10; // block 10 ko.
  var map_h = 20;
  var map ;
  var cur_blocks;
  var map_back_color = "#333333";

  function getDownElem(elem){
    let par = elem.parentNode;
    let c=0;
    let pre = elem.previousSibling
    while(pre){
      c++;
      pre = pre.previousSibling;
    }
    let down = par.nextSibling;
    if(!down) return null;

    down = down.children[0];
    while(c>0){
      down = down.nextSibling;
      c--;
    }
    return down;
  }

  function createMap(){
    map = document.getElementById("map")
    for(let i = 0; i< map_h;i++){
      var tr = document.createElement("tr");
      for(let j=0;j<map_w;j++){
        var dot = document.createElement("td");
        dot.style.width = block_px;
        dot.style.height = block_px;
        tr.appendChild(dot);
      }
      map.appendChild(tr);
    }
    map.style.backgroundColor = map_back_color;
  }


  function init(){
    createMap();
  }

  function makeBlocks(){
    let type = Math.floor( Math.random() * 7 ) ;
    let offset = 2; // offset from left-most edge of the map to left-most of newly created block.
    let color = "red";
    cur_blocks = [];
    switch(type){
      case 0: // I-block
        for(let i=0;i<4;i++) cur_blocks.push(map.children[i].children[offset]);
        color = "lightskyblue";break;
      case 1: // J-block
        cur_blocks.push(map.children[0].children[offset]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "blue";break;
      case 2: // L-block
        cur_blocks.push(map.children[0].children[offset+2]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "orange";break;
      case 3: // O-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "yellow";break;
      case 4: // S-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+1+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "green";break;
      case 5: // T-block
        cur_blocks.push(map.children[0].children[offset+1]);
        for(let i=0;i<3;i++) cur_blocks.push(map.children[1].children[offset+i]);
        color = "purple";break;
      case 6: // Z-block
        for(let i=0;i<2;i++) cur_blocks.push(map.children[0].children[offset+i]);
        for(let i=0;i<2;i++) cur_blocks.push(map.children[1].children[offset+1+i]);
        color ="red";break;
    }
    onBlocks(cur_blocks,color);
  }

  function onBlocks(elems,color){
    for(let elem of elems){
      onBlock(elem,color)
    }
  }
  function offBlocks(elems){
    for(let elem of elems){
      offBlock(elem)
    }
  }
  function onBlock(elem,color){
    elem.style["background-color"] = color;
    elem.isBlock = true;
  }
  function offBlock(elem){
    elem.style["background-color"] = map_back_color;
    elem.isBlock = false;
  }

  function moveDown(){
    let next_cur_blocks = [];
    for(let i=cur_blocks.length-1;i>=0;i--){
      let next_cur_block = getDownElem(cur_blocks[i]);
      if(!next_cur_block || (!cur_blocks.includes(next_cur_block) && next_cur_block.isBlock)){
        checkLine();
        cur_blocks = null;
        return;
      }
      next_cur_blocks.push(next_cur_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(next_cur_blocks, color);
    cur_blocks = next_cur_blocks;
  }

  function moveRight(){
    let right_blocks = [];
    for(let cur_block of cur_blocks){
      let right_block = cur_block.nextSibling;
      if(!right_block || (!cur_blocks.includes(right_block) &&right_block.isBlock)){
        return;
      }
      right_blocks.push(right_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(right_blocks,color);
    cur_blocks = right_blocks;
  }


  function moveLeft(){
    let left_blocks = [];
    for(let cur_block of cur_blocks){
      let left_block = cur_block.previousSibling;
      if(!left_block || (!cur_blocks.includes(left_block) && left_block.isBlock)){
        return;
      }
      left_blocks.push(left_block);
    }
    let color = cur_blocks[0].style.backgroundColor;
    offBlocks(cur_blocks);
    onBlocks(left_blocks,color);
    cur_blocks = left_blocks;
  }


  function getElemFromMap(i,j){
    if(i<0 || j<0 || i>=map_h || j>=map_w){
      return null;
    }
    return map.children[i].children[j];
  }

  function isCurBlock(i,j){
    return cur_blocks.includes(getElemFromMap(i,j));
  }

  function canRotate(from_i,from_j, to_i,to_j){
    let from = getElemFromMap(from_i,from_j);
    let to = getElemFromMap(to_i,to_j);
    if(!from || !to){
      return false;
    }
    return true;
  }

  function rotate(params){
    let tos = [];
    let toIdxs = [];
    let color;
    for(let p of params){
      let from = getElemFromMap(p[0],p[1]);
      let to = getElemFromMap(p[2],p[3]);
      if(!color) color=from.style.backgroundColor;
      for(let i=0;i<cur_blocks.length;i++){
        if(cur_blocks[i] === from){
          toIdxs.push(i);
          tos.push(to);
          offBlock(from);
        }
      }
    }
    console.log(params)
    for(let i=0;i<toIdxs.length;i++){
      onBlock(tos[i],color);
      cur_blocks[toIdxs[i]] = tos[i];
    }
  }


  function moveRotate() {
    let row = map.children;
    let f = false; // ignore firstly found cur_block. because I-Block pattern.
    for(let i=0;i<map_h;i++){
      let colm = row[i].children;
      for(let j=0;j<map_w;j++){
        if(cur_blocks.includes(colm[j]) ){
          if(f === false){
            f = true;
            continue;
          }
          let center_block = colm[j];
          let params = [];
          let dk = i-2;
          let dl = j-2;
          for(let k=0;k<5;k++){
            for(let l=0;l<5;l++){
              if(k==2 && l==2)continue;
              let p = [dk+k, dl+l, dk+(4-l), dl+k];
              if(isCurBlock(p[0],p[1])){
                if(!canRotate(p[0],p[1],p[2],p[3])){
                  return;
                } 
                params.push(p);
              }
            }
          }
          rotate(params);
          return;
        }
      }
    }
  }

  function scoreUp(){
    let score_board = document.getElementById("score");
    let cur_score = parseInt(score_board.innerHTML);
    let next_score = cur_score+ 10;
    score_board.innerHTML = next_score;
  }

  function checkLine(){
    let line = map.children[0];
    while(line){
      let flag = true; // delete line flag.
      let elem = line.children[0];
      while(elem){
        if(!elem.isBlock){
          flag = false;
          break;
        }
        elem = elem.nextSibling;
      }
      if(flag){
        let block = line.children[0];
        while(block){
          offBlock(block)
          block = block.nextSibling;
        }
        let line_tmp = line.previousSibling;
        while(line_tmp){
          let elem = line_tmp.children[0];
          while(elem){
            let down_elem= getDownElem(elem);
            let color = elem.style.backgroundColor;
            if(elem.isBlock) onBlock(down_elem,color);
            offBlock(elem);
            elem = elem.nextSibling;
          }
          line_tmp = line_tmp.previousSibling;
        }
        cur_block = null;
        scoreUp();
      }
      line = line.nextSibling;
    }
  }


  function manager(){
    if(!cur_blocks){
      makeBlocks();
    }else{
      moveDown()
    }
  }

  init();

  document.onkeydown = function(event){
    event.preventDefault()
    if(!cur_blocks) return;
    if (event.keyCode === 37){
      moveLeft();
    }else if (event.keyCode === 39){
      moveRight();
    }else if (event.keyCode === 40){
      moveDown();
    }else if (event.keyCode === 32){
      moveRotate();
    }
  }

  setInterval(function(){
    manager();
    //location.reload();
  },300);
</script>


<style type="text/css">
  table{
    border-collapse: collapse;
    width:200px;
    height:300px;
    border:5px solid #999999;
  }
  table td{
    border: 1px solid black;
  }
  #score{
    border-bottom:1px solid;
    width:60px;
    height:15px;
    margin:10px;
    padding:5px;
    text-align: right;
    vertical-align: center;
    display:inline-block;
  }
</style>
</html>